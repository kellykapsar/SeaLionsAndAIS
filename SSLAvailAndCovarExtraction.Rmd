---
title: "SSLAvailAndCovarExtraction"
author: "Kelly Kapsar"
date: "10/1/2021"
output: html_document
---

```{r load libraries}

library(tidyr)
library(dplyr)
library(sf)
library(raster)
library(ggplot2)
library(scales)
library(ggmap)

```


```{r read in data}

# Set seed
set.seed(1015)

# Read in clean, non-land ssl used locations
ssl <- readRDS("../Data_Processed/watersealis.rds")
ssl$used <- 1
ssl$used <- factor(ssl$used, levels=c(1,0), labels=c("Used","Available"))

# Read in covariates 
landmask <- raster("../Data_Processed/Landmask_GEBCO.tif")
dist500m <- raster("../Data_Processed/Dist500m.tif") %>% raster::mask(landmask, maskvalue=1)
depth <- raster("../Data_Processed/Bathymetry.tif") %>% raster::mask(landmask, maskvalue=1)
distland <- raster("../Data_Processed/DistLand.tif") %>% raster::mask(landmask, maskvalue=1)
slope <- raster("../Data_Processed/slope.tif") %>% raster::mask(landmask, maskvalue=1)

ship <- readRDS("../Data_Processed/AIS_AllOther.rds") 
fish <- readRDS("../Data_Processed/AIS_Fishing.rds")
eke1 <- readRDS("../Data_Processed/eke_weekly_20181101-20200531.rds")
eke2 <- readRDS("../Data_Processed/eke_weekly_20200601-20200731.rds")
ssh1 <- readRDS("../Data_Processed/ssh_weekly_20181101-20200531.rds")
ssh2 <- readRDS("../Data_Processed/ssh_weekly_20200601-20200731.rds")
sst <- readRDS("../Data_Processed/sst_weekly.rds")
wind <- readRDS("../Data_Processed/wind_weekly.rds")

# Create a list of all covariates and check resolution 
raslist <- list(depth, distland, dist500m, slope, ship, fish, sst, eke1, eke2, ssh1, ssh2, wind)
rasres <- lapply(raslist, function(x) res(x)/1000)

# Function to identify random points within a set of polygons 
# This also extracts raster values for static variables in the covar stack 
# Accounts for points on land 

custom_extract_avail <- function(poly, covarstack, npts = 5){
  df <-  as.data.frame(sampleRandom(x=covarstack, size = npts, na.rm = TRUE, ext = as(poly, "Spatial"), xy = TRUE))
  df$Used <- 0
  df$Date <- poly$Date
  df$DeployID <- poly$DeployID
  df$choice_id <- poly$choice_id
  df$year <- poly$year
  df$month <- poly$month
  df$weekofyear <- poly$weekofyear
  return(df)
}


# Extract dynamic covariate data at used locations 
### Modified from FROM AMT PACKAGE
# https://github.com/jmsigner/amt/blob/master/R/extract_covariates.R
# Also helpful: https://cran.r-project.org/web/packages/amt/vignettes/p3_rsf.html
# I modified it so that it works with weekly timescale data 
# DOES NOT work with holes in the data set any more 

extract_covar_var_time_custom <- function(
  xy, t, covariates) {

  t_covar <- raster::getZ(covariates)
  t_obs <- format(as.POSIXct(t), "%G-W%V") # Convert timestamp to week

  wr <- sapply(t_obs, function(x) which(x == t_covar)) # Identify which slice to select
  ev <- raster::extract(covariates, xy) # Extract covariate values for all time slices at all used locations 
  cov_val <- ev[cbind(seq_along(wr), wr)] # select only the relevant time slice for each location
  return(cov_val)
}

```


```{r avail method 1: custom buffer size around used points}

# Create individually buffered points based on 
sealibuffs <- ssl %>% group_by(DeployID) %>% st_buffer(dist=ssl$radius*1000) # Convert radius to m
# st_write(sealibuffs, "../Data_Processed/sealibuffs.shp")

# Create a list of static covariates 
staticcovars <- raster::stack(distland, dist500m, depth, slope)

# Create a list of all covariates and check resolution 
raslist <- list(depth, distland, dist500m, slope, ship, fish, sst, eke1, eke2, ssh1, ssh2, wind)
rasres <- lapply(raslist, function(x) res(x)/1000)


# Extract available locations from buffered used locations 
# Takes ~ 1.3 hours 
# 
# start <- proc.time()
# # q <- lapply(1:length(sealibuffs$DeployID),
# #             function(x){custom_extract_avail(sealibuffs[x,], covarstack=staticcovars)})
# avail <- data.frame()
# for(i in 1:length(sealibuffs$DeployID)){
#   print(i)
#   q <- custom_extract_avail(sealibuffs[i,], covarstack=staticcovars)
#   avail <- rbind(avail, q)
# }
# 
# # avail <- do.call(rbind, q)
# proc.time()-start
# 
# saveRDS(avail, "../Data_Processed/AvailableLocsWithCovars_20211003.rds")

# browseURL("https://www.youtube.com/watch?v=K1b8AhIsSYQ")

# Read in previously extracted available locations (created from above code chunk)
avail <- readRDS("../Data_Processed/AvailablelocswithCovars_20211003.rds")

# Rename x and y into northing and easting
avail <- avail %>% rename(northing = y, easting= x) %>% st_as_sf(coords=c("easting", "northing"), remove=F) 
st_crs(avail) <- st_crs(ssl)

# Extract static covariates at used locations
ssl <- cbind(ssl, raster::extract(staticcovars, ssl))

# Combine available data with used data 
ssl1 <- bind_rows(ssl, avail)

# Extract dynamic weekly covariate values at used and available locations 
# Extract covariate data at used locations 
ssl1$sst <- extract_covar_var_time_custom(xy= st_coordinates(ssl1), t = ssl1$Date, covariates=sst)
ssl1$wind <- extract_covar_var_time_custom(xy= st_coordinates(ssl1), t = ssl1$Date, covariates=wind)
ssl1$ship <- extract_covar_var_time_custom(xy= st_coordinates(ssl1), t = ssl1$Date, covariates=ship)
ssl1$fish <- extract_covar_var_time_custom(xy= st_coordinates(ssl1), t = ssl1$Date, covariates=fish)
ssl11 <- ssl1 %>% filter(!Date > as.POSIXct("2020-06-01", format="%Y-%m-%d")) %>% mutate(
  ssh = extract_covar_var_time_custom(xy= st_coordinates(.), t = .data$Date, covariates=ssh1),
  eke = extract_covar_var_time_custom(xy= st_coordinates(.), t = .data$Date, covariates=eke1)
)
ssl12 <- ssl1 %>% filter(Date > as.POSIXct("2020-06-01", format="%Y-%m-%d")) %>% mutate(
  ssh = extract_covar_var_time_custom(xy= st_coordinates(.), t = .data$Date, covariates=ssh2),
  eke = extract_covar_var_time_custom(xy= st_coordinates(.), t = .data$Date, covariates=eke2)
)
ssl1 <- rbind(ssl11, ssl12)

# Save output
saveRDS(ssl1, "../Data_Processed/UsedAndAvail_SpeedBuff_20211003.rds")

```

```{r avail method 2: resample covars to 5 km}


# Create 5km raster template
ras_5km <- crop(fish, study)
res(ras_5km) <- 5000

# NOT SURE WHY THIS ISN'T WORKING.... WHAT'S UP WITH THE FILE CONNECTION? WILL TRY OVER AGAIN FROM BEGINNING
depth_5km <- resample(depth, ras_5km)
distland_5km <- resample(distland, ras_5km)
dist500m_5km <- resample(dist500m, ras_5km)
slope_5km <- resample(slope, ras_5km)
ship_5km <- resample(ship, ras_5km)
fish_5km <- resample(fish, ras_5km)
sst_5km <- resample(sst, ras_5km) # NOT WORKING: "Cannot open the connection" 
eke1_5km <- resample(eke1, ras_5km)
eke2_5km <- resample(eke2, ras_5km)
ssh1_5km <- resample(ssh1, ras_5km)
ssh2_5km <- resample(ssh2, ras_5km)
wind_5km <- resample(wind, ras_5km) # NOT WORKING: "Cannot open the connection" 


# Extract available locations from buffered used locations 
# Takes ~ 1.3 hours 
# 
start <- proc.time()
q <- lapply(1:length(usedbuff$DeployID),
            function(x){custom_extract_avail(usedbuff[x,], covarstack=covarstack)})
avail <- do.call(rbind, q)
proc.time()-start



# Read in previously extracted available locations (created from above code chunk)
avail <- readRDS("../Data_Processed/AvailablelocswithCovars_5km.rds")





# Extract covariate data at available locations 
avail <- avail %>% rename(northing = y, easting= x)
avail$sst <- extract_covar_var_time_custom(xy= cbind(avail$easting, avail$northing), t = avail$Date, covariates=sst)
avail$wind <- extract_covar_var_time_custom(xy= cbind(avail$easting, avail$northing), t = avail$Date, covariates=wind)
avail$ship <- extract_covar_var_time_custom(xy= cbind(avail$easting, avail$northing), t = avail$Date, covariates=ship)
avail$fish <- extract_covar_var_time_custom(xy= cbind(avail$easting, avail$northing), t = avail$Date, covariates=fish)
avail1 <- avail %>% filter(!Date > as.POSIXct("2020-06-01", format="%Y-%m-%d")) %>% mutate(
  ssh = extract_covar_var_time_custom(xy= cbind(.data$easting, .data$northing), t = .data$Date, covariates=ssh1),
  eke = extract_covar_var_time_custom(xy= cbind(.data$easting, .data$northing), t = .data$Date, covariates=eke1)
)
avail2 <- avail %>% filter(Date > as.POSIXct("2020-06-01", format="%Y-%m-%d")) %>% mutate(
  ssh = extract_covar_var_time_custom(xy= cbind(.data$easting, .data$northing), t = .data$Date, covariates=ssh2),
  eke = extract_covar_var_time_custom(xy= cbind(.data$easting, .data$northing), t = .data$Date, covariates=eke2)
)
avail <- rbind(avail1, avail2)

# Combine used and available data frames

ssl$Used <- factor(ssl$Used, levels=c(1,0), labels=c("Used","Available"))
ssl$DeployID <- factor(ssl$DeployID)

saveRDS(ssl, "../Data_Processed/SSL_UsedAndAvail_WithCovars_5km.rds")

```