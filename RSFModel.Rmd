---
title: "RSFModel"
author: "Kelly Kapsar"
date: "8/19/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Import libraries. 

```{r message=FALSE, warning=FALSE}
library(tidyr)
library(dplyr)
library(sf)
library(raster)
library(ggplot2)
library(scales)
library(ggmap)
library(leaflet)
library(ggplot2)
library(GGally)

opar <- par()      # make a copy of current graphical parameters
```

Study area boundaries. 

```{r study area, warning=FALSE}
# Projection information for WGS84/UTM Zone 5N (EPSG:32605)
prj <- 32605

# Create study area polygon
coords <- data.frame(lat=c(56, 62, 62, 56, 56), lon=c(-155, -155, -143, -143, -155), id="study")
study <- coords %>% 
         st_as_sf(coords = c("lon", "lat"), crs=4326) %>% 
         group_by(id) %>% 
         summarize(geometry = st_combine(geometry)) %>%  
         st_cast("POLYGON") %>% 
         st_transform(prj)
# st_write(study, "../Data_Raw/studyarea.shp")

basemap <- read_sf("../Data_Raw/BBmap.shp") %>% st_transform(prj) %>%  st_buffer(0)

# Crop basemap to buffered extent of study area 
study.buff <- st_buffer(study, 100000) # Buffer study area by 100 km
basemap.crop <- st_crop(basemap, study.buff)

# Map of study area 
ggplot() +
  geom_sf(data=basemap.crop, fill="gray", color="black", lwd=0.5) +
  geom_sf(data=study, fill=NA, color="red")

# Get latlong coordinates for study area for use in downloading other data sets
studylatlon <- study %>% st_transform(4269) %>% st_bbox()

```

Pull in SSL data. 

```{r}
ssl_orig <- readRDS("../Data_Processed/Telemetry/UsedAndAvail_WeeklyMCP_20211014.rds")  %>% 
                    st_drop_geometry() %>% 
                    group_by(deploy_id, date) %>% 
                    mutate(choice_id = cur_group_id()) %>% 
                    ungroup()

# Collect only complete cases 
ssl <- ssl_orig %>% filter(complete.cases(.))

```


```{r covariate plots}

summary(ssl); cat("\n")

library(tidyverse)
# Violin plot tutorial: https://www.r-graph-gallery.com/violin_and_boxplot_ggplot2.html

# Violin plots of all covars: used vs. available
imap(dplyr::select(ssl, -deploy_id, -weeklyhr_id, -used, -choice_id, -date, -year, -ais_bounds, -weekofyear), ~ {
  ggplot(ssl, aes(x=used, y=.x, fill=used)) +
    geom_violin() +
    geom_boxplot(width = 0.1, alpha=0.2, color="grey") +
    ylab(.y)
})

# Violin plots of all covars: by individual
imap(dplyr::select(ssl, -deploy_id, -weeklyhr_id, -used, -choice_id, -date, -year, -ais_bounds, -weekofyear), ~ {
  ggplot(ssl, aes(x=deploy_id, y=.x, fill=deploy_id)) +
    geom_violin() +
    geom_boxplot(width = 0.1, alpha=0.2, color="grey") +
    ylab(.y) +
    theme(axis.text.x = element_text(angle = 90))
})

# Correlations between covariates 
ssl %>% dplyr::select(bathymetry, dist_land, dist_500m, slope, ssh, eke, wind, fish, ship, sst, prox_ships_km, prox_fish_km)%>% 
  ggcorr(label=T)


# VIOLIN PLOTS INSTEAD
```

```{r centering variables}

ssl$Bathymetry.ctd <- ssl$Bathymetry - mean(ssl$Bathymetry)
ssl$DistLand.ctd <- ssl$DistLand - mean(ssl$DistLand)
ssl$Dist500m.ctd <- ssl$Dist500m - mean(ssl$Dist500m)
ssl$slope.ctd <- ssl$slope - mean(ssl$slope)
ssl$ssh.ctd <- ssl$ssh - mean(ssl$ssh)
ssl$eke.ctd <- ssl$eke - mean(ssl$eke)
ssl$wind.ctd <- ssl$wind - mean(ssl$wind)
ssl$fish.ctd <- ssl$fish - mean(ssl$fish)
ssl$ship.ctd <- ssl$ship - mean(ssl$ship)
ssl$sst.ctd <- ssl$sst - mean(ssl$sst)




```

